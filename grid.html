<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Masonry Gallery</title>
  <style>
    .body-lock { overflow: hidden; position: fixed; width: 100%; }
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: sans-serif; background: #fafafa; padding: 20px }
    html { overflow-y: scroll; }

    .filters { text-align: center; margin-bottom: 20px; }
    .filters button {
      background: #eee; border: none; margin: 0 5px;
      padding: 8px 16px; border-radius: 4px; cursor: pointer;
      transition: background .3s;
    }
    .filters button.active,
    .filters button:hover {
      background: #f49892; color: #fff;
    }

    .album {
      position: relative; max-width: 1320px; margin: 0 auto;
    }
    .album-item {
      width: calc((100% / 3) - 10px); margin-bottom: 10px;
      position: relative; overflow: hidden; border-radius: 8px;
      background: #ddd; cursor: pointer;
    }
    @media (max-width: 1024px) { .album-item { width: calc((100% / 2) - 10px); } }
    @media (max-width: 768px)  { .album-item { width: 100%; } }

    .album-item img {
      width: 100%; height: auto; object-fit: cover; display: block;
    }
    .tag {
      position: absolute; top: 8px; left: 8px;
      background: rgba(255,255,255,0.9); color: #333;
      padding: 2px 6px; font-size: .75rem; border-radius: 3px;
    }
    .tag.right { left: auto; right: 8px; }

    .overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.6);
      color: #fff; opacity: 0; display: flex;
      flex-direction: column; justify-content: center;
      align-items: center; text-align: center;
      padding: 12px; transition: opacity .3s;
    }
    .album-item:hover .overlay { opacity: 1; }
    .overlay h3 { margin-bottom: 6px; font-size: 1.1rem; }
    .overlay p  { font-size: .9rem; }

    .lightbox {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.95); display: none;
      justify-content: center; align-items: center;
      flex-direction: column; z-index: 1000; color: #fff;
      padding: 20px;
    }
    .lightbox.active { display: flex; }

    .slide-container {
      position: relative;
      transition: transform 0.3s ease;
      max-width: 90%;
      max-height: 80%;
      text-align: center;
    }
    .slide-container img {
      width: 100%; height: auto; display: block; margin-bottom: 20px;
      border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .slide-container h2 { margin-bottom: 15px; font-size: 2rem; }
    .slide-container p {
      font-size: 1.1rem; text-align: center; max-width: 700px;
      line-height: 1.7;
    }

    .nav-btn {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,0.2); color: #fff;
      border: none; font-size: 2rem; padding: 15px 25px;
      cursor: pointer; border-radius: 50%; width: 60px;
      height: 60px; display: flex; align-items: center;
      justify-content: center; transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    .nav-btn:hover { background: rgba(255,255,255,0.4); }
    .nav-prev { left: 30px; }
    .nav-next { right: 30px; }

    .close-btn {
      position: absolute; top: 30px; right: 30px;
      background: rgba(255,255,255,0.3); border: none;
      font-size: 2rem; color: #fff; cursor: pointer;
      width: 50px; height: 50px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .close-btn:hover { background: rgba(255,255,255,0.6); transform: rotate(90deg); }

    #lightbox-link {
      display: none; margin-top: 12px;
      text-decoration: underline; color: #f49892;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #loader {
      position:fixed; inset:0; background:rgba(255,255,255,0.8);
      z-index:9999; display:flex; align-items:center; justify-content:center;
    }
    #loader div {
      border:4px solid #f3f3f3; border-top:4px solid #f49892;
      border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div class="text-center mt-4">
    <a
      href="portfolio.html"
      target="_top"
      style="
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border: 2px solid #6c63ff;
        border-radius: 0.5rem;
        color: #6c63ff;
        font-weight: 600;
        text-decoration: none;
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        margin-bottom: 20px;
      "
      onmouseover="
        this.style.backgroundColor = '#6c63ff';
        this.style.color = '#ffffff';
        this.style.transform = 'translateY(-2px)';
      "
      onmouseout="
        this.style.backgroundColor = 'transparent';
        this.style.color = '#6c63ff';
        this.style.transform = 'translateY(0)';
      "
       onclick="
       const parentUrl = window.location.origin
                       + window.location.pathname.replace(/[^\/]*$/, 'index.html');
       window.top.location.href = parentUrl;
       return false;
     "
    >
      Home
    </a>
  </div>
  
    
  <div class="filters" id="filters"></div>
  <div class="album" id="gallery"></div>

  <div class="lightbox" id="lightbox">
    <button class="close-btn">×</button>
    <div class="slide-container">
      <img id="lightbox-img" src="" alt="">
      <h2 id="lightbox-title"></h2>
      <p id="lightbox-desc"></p>
      <a id="lightbox-link" href="" target="_blank" rel="noopener">Visit source</a>
    </div>
    <button class="nav-btn nav-prev">‹</button>
    <button class="nav-btn nav-next">›</button>
  </div>

  <div id="loader"><div></div></div>

  <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
  <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script>
    const GSA_URL = 'https://script.google.com/macros/s/AKfycbyDodKXTRdgaKbEmFGr23U9GyRyzBBY3pMLw9wZQDq9ZBSrCM3q-aaX7nVcEsraXW4EpA/exec';
    const loader = document.getElementById('loader');
    const filtersEl = document.getElementById('filters');
    loader.style.display = 'flex';

    // Grab hash tag (decoded), empty string if none or "#"
    const hashTag = decodeURIComponent(window.location.hash.slice(1) || '');

    let iso, allItems, currentSet, currentIndex = 0;

    fetch(`${GSA_URL}?type=gallery`)
      .then(r => r.json())
      .then(items => {
        // If hashTag (not "All"), filter array first & hide filters bar
        const filteredItems = (hashTag && hashTag !== 'All')
          ? items.filter(i => i.tags.includes(hashTag))
          : items;

        buildGallery(filteredItems);

        // Only in full mode (no hash or "All") do we listen/apply hashchange
        if (!hashTag || hashTag === 'All') {
          window.addEventListener('hashchange', applyFilterFromHash);
          applyFilterFromHash();
        }
      })
      .catch(err => {
        loader.textContent = 'Failed to load content.';
        console.error(err);
      });

    function buildGallery(items) {
      const galleryEl = document.getElementById('gallery');

      // Hide filters entirely in single-tag mode
      if (hashTag && hashTag !== 'All') {
        filtersEl.style.display = 'none';
      } else {
        // Render filter buttons
        const tagSet = new Set();
        items.forEach(i => i.tags.forEach(t => tagSet.add(t)));
        const tags = ['All', ...tagSet];
        filtersEl.innerHTML = tags.map((t, i) =>
          `<button class="filter-btn${i===0?' active':''}" data-filter="${t}">${t}</button>`
        ).join('');
      }

      // Render gallery items
      galleryEl.innerHTML = items.map(i => {
        const spans = i.tags.map((t, idx) =>
          `<span class="tag${idx>0?' right':''}">${t}</span>`
        ).join('');
        return `
          <div class="album-item"
               data-tags="${i.tags.join(',')}"
               data-title="${i.title}"
               data-desc="${i.description}"
               data-link="${i.linkUrl||''}">
            ${spans}
            <img src="${i.imageUrl}" alt="${i.altText}">
            <div class="overlay"><h3></h3><p></p></div>
          </div>`;
      }).join('');

      // Initialize Isotope after images load
      imagesLoaded(galleryEl, () => {
        iso = new Isotope(galleryEl, {
          itemSelector: '.album-item',
          layoutMode: 'masonry',
          masonry: { columnWidth: '.album-item', gutter: 10 },
          horizontalOrder: true
        });

        allItems = Array.from(galleryEl.querySelectorAll('.album-item'));
        allItems.forEach(el => {
          el.querySelector('h3').textContent = el.dataset.title;
          el.querySelector('p').textContent  = el.dataset.desc;
          el.addEventListener('click', () => {
            updateCurrentSet();
            currentIndex = currentSet.indexOf(el);
            openLightbox(currentIndex, 0);
          });
        });
        currentSet = allItems.slice();

        // Wire up filter buttons only in full mode
        if (!hashTag || hashTag === 'All') {
          document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
              btn.classList.add('active');
              const f = btn.dataset.filter;
              iso.arrange({ filter: f==='All' 
                ? '*' 
                : item => item.dataset.tags.split(',').includes(f)
              });
              updateCurrentSet();
              history.replaceState(null, '', f==='All'
                ? window.location.pathname 
                : `#${encodeURIComponent(f)}`);
            });
          });
        }

        initLightboxControls();
        loader.style.display = 'none';
      });
    }

    // Used only in full mode
    function applyFilterFromHash() {
      const tag = decodeURIComponent(window.location.hash.slice(1) || 'All');
      const btn = Array.from(document.querySelectorAll('.filter-btn'))
                       .find(b => b.dataset.filter === tag);
      if (btn) btn.click();
    }

    function updateCurrentSet() {
      currentSet = iso.getFilteredItemElements();
    }

    function openLightbox(idx, direction = 0) {
      const el = currentSet[idx];
      const img = el.querySelector('img');
      const linkUrl = el.dataset.link;
      const container = document.querySelector('.slide-container');

      function setContent() {
        document.getElementById('lightbox-img').src   = img.src;
        document.getElementById('lightbox-img').alt   = img.alt;
        document.getElementById('lightbox-title').textContent = el.dataset.title;
        document.getElementById('lightbox-desc').textContent  = el.dataset.desc;
        const btn = document.getElementById('lightbox-link');
        if (linkUrl) {
          btn.href = linkUrl;
          btn.style.display = 'inline-block';
        } else {
          btn.style.display = 'none';
        }
      }

      if (direction !== 0) {
        container.style.transform = `translateX(${-direction * 100}%)`;
        container.addEventListener('transitionend', onTransitionEnd, { once: true });
      } else {
        setContent();
        container.style.transform = 'translateX(0)';
      }

      function onTransitionEnd() {
        setContent();
        container.style.transition = 'none';
        container.style.transform = `translateX(${direction * 100}%)`;
        container.offsetHeight; // reflow
        container.style.transition = 'transform 0.3s ease';
        container.style.transform = 'translateX(0)';
      }

      document.getElementById('lightbox').classList.add('active');
      document.body.classList.add('body-lock');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
      document.body.classList.remove('body-lock');
    }

    function navigate(dir) {
      const len = currentSet.length;
      currentIndex = (currentIndex + dir + len) % len;
      openLightbox(currentIndex, dir);
    }

    function initLightboxControls() {
      const lightboxEl = document.getElementById('lightbox');
      let startX = 0, endX = 0;
      const threshold = 50;

      document.querySelector('.close-btn').onclick = closeLightbox;
      document.querySelector('.nav-prev').onclick  = () => navigate(-1);
      document.querySelector('.nav-next').onclick  = () => navigate(1);

      document.addEventListener('keydown', e => {
        if (!lightboxEl.classList.contains('active')) return;
        if (e.key === 'ArrowRight') navigate(1);
        if (e.key === 'ArrowLeft')  navigate(-1);
        if (e.key === 'Escape')     closeLightbox();
      });

      lightboxEl.addEventListener('click', e => {
        if (e.target === lightboxEl) closeLightbox();
      });

      lightboxEl.addEventListener('touchstart', e => {
        if (e.touches.length === 1) startX = e.touches[0].pageX;
      });
      lightboxEl.addEventListener('touchend', e => {
        endX = e.changedTouches[0].pageX;
        const dx = endX - startX;
        if (Math.abs(dx) > threshold) dx > 0 ? navigate(-1) : navigate(1);
      });
    }
  </script>
</body>
</html>
